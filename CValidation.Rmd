---
title: "Urban Fires | Content Validation"
author: "Regina Bispo"
date: "2023-02-07"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: true
    toc_depth: 3    
    number_sections: true
---

Run Raw2Final.Rmd before running this file.

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
	eval = TRUE,
	message = FALSE,
	warning = FALSE,
	comment = " ",
	include = TRUE
)

library(ggplot2)
library(dplyr)
library(maps)
library(dbscan)
library(factoextra)
library(RgoogleMaps)
library(maps) 
library(mapdata) 
library(rgdal)
library(viridis)
library(RColorBrewer)
library(tidygeocoder)
library(dplyr)
library(raster)
library(tmap)
library(rgeos)
library(sf)
library(spatstat)
library(geosphere)
library(readxl)
library(googleway)
library(deldir)
library(OpenStreetMap)
library(hms)
library(janitor)
library(stringr)
library(stringi)
library(here)
library(stargazer)
library(writexl)
library(formatR)
library(xlsx)
library(knitr)
library(lubridate)
library(validate)
library(gridExtra)

load('Env1.RData')
```


# Content Validation

## Intial summary statistics

```{r}
summary(data)
```


```{r,include=FALSE}
n9=dim(data);n9
```

At this step, the dataset included `r n9[1]` objects and `r n9[2]` variables.


### Variable length

```{r}
summary(data$length)
```

Removing incorrect lengths:

```{r}
assign("le", read_xlsx("LengthErrors.xlsx"))
data[data$id %in% le$error,] %<>%
  mutate(length = NA, close = NA)
```

Checking correction:

```{r}
summary(data$length)
```

### Resources

Removing incorrect values:

```{r}
data[data$groundhr==0 & data$groundtr==0 & data$airhr==0 & data$airtr==0, ] %<>%
  mutate(groundhr=NA, groundtr=NA, airhr=NA, airtr=NA)

summary(data)

```



```{r,include=FALSE}
n10=dim(data);n10
```

At this step, the dataset included `r n10[1]` objects and `r n10[2]` variables.


## Exploratory data analysis

```{r}
str(data)
summary(data)
```


### Fire importance


The next chunk gives the distribution of the fire importance (table and plot):

```{r}
ctab(var = importance)
```

### Ignition date/time

The next chunks gives the distribution of the events as a function of:


+ Year

```{r}
ty<-ctab(var = format(open,format="%Y"))[[1]];ty
min(ty$n)
max(ty$n)
mean(ty$n)
```


+ Month of occurence

```{r}
ctab(var = lubridate::month(data$open,label = TRUE))
```

+ Weekday

```{r}
tab=data %>% 
  count(wd=factor(weekdays(data$open),
                  levels = unique(weekdays(data$open)),
                  labels = c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")), sort = TRUE) %>% 
  arrange(desc(n)) %>%
  mutate(prop=n/nrow(data)) %>% arrange(-prop)

ggplot(tab, aes(y = reorder(wd, prop),x=prop)) +
 geom_bar(stat="identity", position = position_stack(reverse = TRUE),fill="black",alpha=0.7) + ylab(" ") + xlab("Proportion") +
 theme(legend.position = "top")+theme_bw()
```


+ Hour of the day

```{r}
ctab(var = as.POSIXlt(data$open)$hour)
```


```{r,fig.width=6,fig.height=5,include=FALSE}
v1=format(data$open,format="%Y")
v2=factor(lubridate::month(data$open,label = TRUE),levels = unique(month(data$open,label = TRUE)), labels = c("jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"))
v3=factor(weekdays(data$open), levels = unique(weekdays(data$open)), labels = c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")) 
v4=as.POSIXlt(data$open)$hour
  
tab1=data %>%
  mutate(x=v1) %>%
  count(x, sort = TRUE) %>% 
  mutate(Proportion=round(n/nrow(data),4)) %>% arrange(-Proportion) 

p1=ggplot(tab1, aes(x,Proportion)) + 
  geom_bar(stat = "identity")+
  labs(x=" ",y="Frequency")+theme_bw()+
  geom_bar(stat="identity",color="black",fill="white")+  
  geom_text(aes(label = paste0(sprintf("%4.1f", Proportion * 100), "%")),cex=2.5,vjust=2)+ ggtitle("(A)")

tab2=data %>%
  mutate(x=v2) %>%
  count(x, sort = TRUE) %>% 
  mutate(Proportion=round(n/nrow(data),4)) %>% arrange(-Proportion) 

p2=ggplot(tab2, aes(x,Proportion)) + 
  geom_bar(stat = "identity")+
  labs(x=" ",y="Frequency")+theme_bw()+
  geom_bar(stat="identity",color="black",fill="white")+  
  geom_text(aes(label = paste0(sprintf("%4.1f", Proportion * 100), "%")),cex=2.5,vjust=2)+ ggtitle("(B)")

tab3=data %>%
  mutate(x=v3) %>%
  count(x, sort = TRUE) %>% 
  mutate(Proportion=round(n/nrow(data),4)) %>% arrange(-Proportion) 

p3=ggplot(tab3, aes(x,Proportion)) + 
  geom_bar(stat = "identity")+
  labs(x=" ",y="Frequency")+theme_bw()+
  geom_bar(stat="identity",color="black",fill="white")+  
  geom_text(aes(label = paste0(sprintf("%4.1f", Proportion * 100), "%")),cex=3,vjust=2)+ ggtitle("(C)")+
  theme(axis.text.x = element_text(size = 6))

tab4=data %>%
  mutate(x=v4) %>%
  count(x, sort = TRUE) %>% 
  mutate(Proportion=round(n/nrow(data),4)) %>% arrange(-Proportion) 

p4=ggplot(tab4, aes(x,Proportion)) + 
  geom_bar(stat = "identity")+
  labs(x=" ",y="Frequency")+
  geom_bar(stat="identity",color="black",fill="white")+  
  geom_text(aes(label = paste0(sprintf("%4.1f", Proportion * 100), "%"),angle=90),cex=3,hjust=1.2) +
  theme_bw()+ ggtitle("(D)")

grid.arrange(p1,p2,p3,p4, nrow = 2)
```

### Total counts per district

```{r maps,fig.width=10,fig.height=5,warning=FALSE}
#Fire data by district
map=dist[dist$NAME_0=="Portugal",]
map$NAME_1=factor(map$NAME_1)
PTdist=data %>% count(district, sort = TRUE)
colnames(PTdist)=c("NAME_1","n")
levels(PTdist$NAME_1)=levels(map$NAME_1)
mapadist=merge(map,PTdist,by="NAME_1", all.x=T)

#Fire departments by district
FSdist=data %>%
  group_by(district) %>%
  summarize(count_distinct = n_distinct(pfd))
colnames(FSdist)=c("NAME_1","n")
levels(FSdist$NAME_1)=levels(map$NAME_1)
mapadistfs=merge(map,FSdist,by="NAME_1", all.x=T)
```

Mapping:

```{r}
p1=tm_shape(mapadist)+
  tm_polygons("n", style="kmeans",palette="Reds",breaks=quantile(mapadist$n),title="N. of events")+
  tm_text("NAME_1",size = 0.5, fontfamily="sans", ymod = 0.4)+
  tm_graticules()+
  tm_layout(legend.outside = TRUE, legend.outside.position = "right")+
tm_shape(mapadist)+
  tm_polygons("n", style="kmeans",palette="Reds",breaks=quantile(mapadist$n),legend.show=FALSE,alpha = 0.1)+
  tm_text("n", size = 0.5, fontfamily="sans", ymod = -.1)

bks=c(11,21,26,31,41,56)
p2=tm_shape(mapadistfs)+
  tm_polygons("n",palette="Greens",breaks=bks,title="N. of fire departments")+
  tm_text("NAME_1",size = 0.5, fontfamily="sans", ymod = 0.4)+
  tm_graticules()+
  tm_layout(legend.outside = TRUE, legend.outside.position = "right")+
tm_shape(mapadistfs)+
  tm_polygons("n", palette="Greens",breaks=bks,legend.show=FALSE,alpha = 0.1)+
  tm_text("n", size = 0.5, fontfamily="sans", ymod = -.1)

tmap_arrange(p1,p2)
```

### Fire type


```{r}
tab=data %>% 
  count(type, sort = TRUE) %>% 
  mutate(prop=n/nrow(data)) %>% arrange(-prop) 

ggplot(tab, aes(y = reorder(type, prop),x=prop)) +
 geom_bar(stat="identity", position = position_stack(reverse = TRUE),color="black",fill="white") + ylab(" ") + xlab("Proportion") +
 theme(legend.position = "top")+theme_bw()+ 
  geom_text(aes(label = paste0(sprintf("%4.2f", prop * 100), "%")),cex=3,hjust=0.01,nudge_x = 0.01) +
  theme(plot.margin = unit(c(2,3,2,2), "cm"))+xlim(c(0,1))+ ggtitle("(A)")
```

The code below maps the total counts per type of fire (residential vs. not).

```{r maps1,fig.width=10,fig.height=5,warning=FALSE}
#Residential
TypeDist=data[data$type=="Residential",] %>%
  count(district, sort = TRUE)
colnames(TypeDist)=c("NAME_1","n")
levels(TypeDist$NAME_1)=levels(map$NAME_1)
mapadisttype=merge(map,TypeDist,by="NAME_1", all.x=T)

# Other
TypeDisto=data[data$type!="Residential",] %>%
  count(district, sort = TRUE)
colnames(TypeDisto)=c("NAME_1","n")
levels(TypeDisto$NAME_1)=levels(map$NAME_1)
mapadisttypeo=merge(map,TypeDisto,by="NAME_1", all.x=T)

tmap_options(check.and.fix = TRUE)

p3=tm_shape(mapadisttype)+
  tm_polygons("n",palette="Blues",breaks=quantile(mapadisttype$n),title="N. of events")+
  tm_text("NAME_1",size = 0.5, fontfamily="sans", ymod = 0.4)+
  tm_graticules()+
  tm_layout(legend.outside = TRUE, legend.outside.position = "right")+#,title = "(B)"
tm_shape(mapadisttype)+
  tm_polygons("n",palette="Blues",breaks=quantile(mapadisttype$n),legend.show=FALSE,alpha = 0.1)+
  tm_text("n", size = 0.5, fontfamily="sans", ymod = -.1)


p4=tm_shape(mapadisttypeo)+
  tm_polygons("n", palette="Blues",breaks=quantile(mapadisttype$n),title="N. of events")+
  tm_text("NAME_1",size = 0.5, fontfamily="sans", ymod = 0.4)+
  tm_graticules()+
  tm_layout(legend.outside = TRUE, legend.outside.position = "right")+#,title = "(C)"
 tm_shape(mapadisttypeo)+
   tm_polygons("n", palette="Blues",breaks=quantile(mapadisttype$n),legend.show=FALSE,alpha = 0.1)+
  tm_text("n", size = 0.5, fontfamily="sans", ymod = -.1)

tmap_arrange(p3,p4)
```



### Frequency of fires per location

The next chunk builds a dataframe quantifying the number of objects with exactly the same coordinates. 

```{r}
namesd=sort(unique(data$district))
years=as.numeric(unique(format(data$open,format="%Y")))

uflocal<-list()

for(i in namesd){
  uflocalyear<-data.frame()
  for (j in 1:length(years)) {
  temp<-nburn(i,years[j])
  uflocalyear<-rbind(uflocalyear,temp)
  }
  uflocal[[i]]<-uflocalyear
  }

ufreps<-bind_rows(Filter(is.data.frame, uflocal))
rownames(ufreps)<-NULL
```

This chunk presents an example:

```{r}
ufreps[ufreps$District=="Braga"&ufreps$Year==2022,]

```


In this example there were `r ufreps[ufreps$District=="Braga",][3,3]` locations for which only `r ufreps[ufreps$District=="Braga",][3,2]` event was registered.

The next chunk produces a bubble plot for each one of the districts (Braga), in which the size of the bubble is proportion to the num of fires within the same location.

```{r,fig.width=18,fig.height=8}
# Bubble plot
crep=data.frame(data[,c("district","open","lon","lat")])
crep2sp<-data.frame(data[,c("district","open","lon","lat")])
crep2sp$year = as.numeric(format(data$open,format="%Y"))
coordinates(crep2sp)=~lon+lat
#builds a list containing points with zero distance by year
list.d0=sapply(split(crep2sp, as.numeric(format(data$open,format="%Y"))), zerodist)
#transforms to data.frame
df.d0=as.data.frame(do.call(rbind, unname(Map(cbind, id = names(list.d0), list.d0))))
colnames(df.d0)=c("year","v1","v2")

crep$year<-format(crep$open,format="%Y")
bubble=crep[crep$lon %in% crep[df.d0[,2],"lon"],] %>%
    arrange(district,year,lon) %>%
  count(district,year,lon,lat)
coordinates(bubble)=~lon+lat
bks=c(2,4,6,Inf)
tmap_options(check.and.fix = TRUE)
for (i in 1:length(unique(bubble$district))) {
  name=paste(unique(bubble$district)[i])
 tm_shape(freg[freg$NAME_1==name,]) + 
          tm_borders() + 
          tm_dots(size=0.1,col="red") + 
        tm_shape(bubble[bubble$district==name,])+ 
          tm_bubbles(size = "n", col="n",alpha=0.4, breaks=bks, legend.size.show = FALSE, title.col = "Frequency") +  tm_facets(by = "year", ncol = 6) + 
          tm_layout(main.title= paste(name), main.title.position = "center",main.title.size = 3,legend.text.size = 2, legend.title.size = 3,frame=FALSE,legend.outside.size = 0.3,panel.label.size = 3)
  }

```

Example:

```{r,fig.width=18,fig.height=8}
i=3
name=paste(unique(bubble$district)[i])
  print(tm_shape(freg[freg$NAME_1==name,]) + 
          tm_borders() + 
          tm_dots(size=0.03,col="red") + 
        tm_shape(bubble[bubble$district==name&bubble$year=="2013",])+ 
          tm_bubbles(size = "n", col="n",alpha=0.4, breaks=bks, legend.size.show = FALSE, title.col = "Frequency") + 
          tm_layout(main.title= " ", main.title.position = "center",main.title.size = 2,legend.text.size = 1, legend.title.size = 1.5,frame=FALSE))
```


### Parish centroids

The next chunk creates two spatial objects (class sf): (1) data_sf - containing all fire events and (2) cents_sf - containing all parish centroids.

```{r}
#dataset
data_sf <- data[,c("district","municipality","parish","lon","lat")] %>%
  st_as_sf(coords = c('lon', 'lat')) %>%
  st_set_crs("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 +units=km")

#centroids
cents<-data.frame(district=freg$NAME_1,municipality=freg$NAME_2,parish=freg$NAME_3,cent.x=NA,cent.y=NA)
for (i in 1:nrow(cents)) {
  cents[i,"cent.x"]<-gCentroid(freg[i,],byid=TRUE)@coords[1]
  cents[i,"cent.y"]<-gCentroid(freg[i,],byid=TRUE)@coords[2]
}
cents_sf <- cents %>%
   st_as_sf(coords = c('cent.x', 'cent.y')) %>%
   st_set_crs("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 +units=km")
```


The next chunk defines a buffer of 10 meters around each parish centroid.

```{r}
d<-0.01 #km
cents_buff<-st_buffer(cents_sf, units::as_units(d, 'kilometer')) #10 metros
```

The next chunk creates a dataframe containing fire events, the respective parish centroids and the distance between the ignition point and the parish centriod. Points within the 10 meters buffer are idenfified.

```{r,fig.width=15}
#merge data
data.cents<-merge(data[,c("district","municipality","parish","lon","lat")],cents,by.x=c("district","municipality","parish"),by.y=c("district","municipality","parish"))
data.cents$dist<-pointDistance(data.cents[,c("lon","lat")], data.cents[,c("cent.x","cent.y")], lonlat=TRUE, allpairs=FALSE)/1000
data.cents$buff<-ifelse(data.cents$dist<=d,1,0)
```

The code below produces a map with an example (Fafe parish, Braga district). Red points are within the buffer (in); blue points are outside the buffer (out).

```{r,fig.width=15}
FregPlot=freg[freg$NAME_3=="Fafe",]
plot(FregPlot,main=paste("Fafe"),cex.main=1)
plot(cents_buff[cents_buff$parish=="Fafe",],col="grey80",add=TRUE)
points(cents$cent.x[cents$parish=="Fafe"],cents$cent.y[cents$parish=="Fafe"],col="black",pch=16,cex=0.5)
points(data.cents[data.cents$parish=="Fafe",c("lon","lat")],pch=4,cex=0.8,col=ifelse(data.cents[data.cents$parish=="Fafe","buff"]==0,4,2),lwd=2)
text(data.cents[data.cents$parish=="Fafe",c("lon","lat")],ifelse(data.cents[data.cents$parish=="Fafe","buff"]==0,"out","in"),col=ifelse(data.cents[data.cents$parish=="Fafe","buff"]==0,4,2),pos=4)
```
### Coordinates type

The next chunk adds a new variable (cty - coordinates type) to the dataset to distinguish this type of coordinates (inside vs. outside buffer), i.e., exact vs. not exact (taken by the parish centroid).

```{r}
data$cty<-factor(data.cents$buff,labels = c("exact","not exact"))
round(prop.table(table(data$cty))*100)
```


Variable distribution:
```{r}
ctab(var = cty)
```

Description by distric:
```{r}
data %>%
  group_by(district) %>%
  count(cty) %>%
  group_by(district) %>%
  mutate(perc=round(n/sum(n)*100,1))
```



### Administrative units

##### District

```{r}
tab=data %>% 
  count(district, sort = TRUE) %>% 
  arrange(desc(n)) %>%
  mutate(prop=n/nrow(data)) %>% arrange(-prop)
tab

ggplot(tab, aes(y = reorder(district, prop),x=prop)) +
 geom_bar(stat="identity", position = position_stack(reverse = TRUE),fill="black",alpha=0.7) + ylab(" ") + xlab("Proportion") +
 theme(legend.position = "top")+theme_bw()
```

##### Municipality

```{r}
tab=data %>% 
  group_by(district) %>%
  count(municipality, sort = TRUE) %>% 
  arrange(desc(n)) %>%
  mutate(prop=round(n/nrow(data),4)) %>% arrange(-prop)
tab[tab$prop>0.01,]
```

### Length

```{r}
summary(data$length)
```
```{r}
qtab("length")
```


### Resources

#### Ground human resources

```{r}
qtab(var = "groundhr")

table(cut(data$groundhr,c(0,5,10,15,20,25,30,141,257)))

round(prop.table(table(cut(data$groundhr,c(0,5,10,15,20,25,30,141,257))))*100)

```


#### Ground tecnhical resources

```{r}
qtab(var = "groundtr")

plot(table(data$groundtr))

table(cut(data$groundtr,c(0,1,3,5,7,9,11,49)))

round(prop.table(table(cut(data$groundtr,c(0,1,3,5,7,9,11,49))))*100)

```

#### Air resources

+ human

```{r}
table(data$airhr)
round(round(prop.table(table(data$airhr))*100,3),1)

round(cumsum(prop.table(table(data$airhr))*100),3)


```

+ technical

```{r}
table(data$airtr)
round(prop.table(table(data$airtr)),3)
```

### Victims

+ major injuries

```{r}
table(data$major)
round(prop.table(table(data$major)),3)

```

+ minor injuries

```{r}
table(data$minor)
round(prop.table(table(data$minor)),3)

```

+ deaths

```{r}
table(data$deaths)
round(prop.table(table(data$deaths)),3)

```

### Reignition

```{r}
ctab(var = reignit)
```


# Checking rules


```{r}
new.rules <- validator(
   r1=is.numeric(data$id),
  r2=is_unique(data$id),
  r3=is.factor(data$importance),
  r4=data$importance %in% c("low","medium","high","unknown"),
  r5= data$importance[data$deaths==0 & (data$major+data$minor)<5 & data$length<30]=="low",
  r6= data$importance[data$deaths>=1 | (data$major+data$minor)>=10 | data$length>=60]=="high",
  r7= data$importance[data$deaths==0 & (data$major+data$minor)<10 & data$length>=30 & data$length<60]=="medium",
  r8=is.POSIXct(data$open),
  r9=in_range(data$open,min="2013-01-01 00:00:00",max="2022-12-31 23:59:00"),
  r10=is.POSIXct(data$close),
  r11=in_range(data$close,min="2013-01-01 00:00:00",max="2023-01-01 23:59:00"),
  r12=data$close > data$open,
  r13=is.numeric(data$length),
  r14=data$length>0,
  r15=data$length == difftime(data$close,data$open,units = "mins"),
  r16=is.factor(data$type),
  r17=length(levels(data$type))<=length(structure.list),
  r18=data$type %in% structure.list,
  r19=is.factor(data$region),
  r20=length(levels(data$region))<=length(region.list),
  r21=data$region %in% region.list,
  r22=is.factor(data$subregion),
  r23=length(levels(data$subregion))<=length(subregion.list),
  r24=data$subregion %in% subregion.list,
  r25=is.factor(data$district),
  r26=length(levels(data$district)) <= length(levels(as.factor(dist$NAME_1))),
  r27=data$district %in% dist$NAME_1,
  r28=listunmatch(dist.list,matchdist)==0,
  r29=is.factor(data$municipality),
  r30=length(levels(data$municipality)) <= length(levels(as.factor(conc$NAME_2))),  
  r31=data$municipality %in% conc$NAME_2, 
  r32=listunmatch(mun.list,matchmun)==0,
  r33=is.factor(data$parish),
  r34=length(levels(data$parish)) <= length(levels(as.factor(freg$NAME_3))),
  r35=data$parish %in% freg$NAME_3,
  r36=listunmatch(par.list,matchpar)==0,
  r37=is.numeric(data$lat),
  r38=in_range(data$lat, min=dist@bbox[2,1], max=dist@bbox[2,2]),
  r39=is.numeric(data$lon),
  r40=in_range(data$lon, min=dist@bbox[1,1], max=dist@bbox[1,2]),
  r41=is.factor(data$pfd),
  r42=is.numeric(data$groundhr),
  r43=is.numeric(data$groundtr),
  r44=is.numeric(data$airhr),
  r45=is.numeric(data$airtr),
  r46=is.numeric(data$deaths),
  r47=is.numeric(data$major),
  r48=is.numeric(data$minor),
  r49=is.numeric(data$assist),
  r50=is.numeric(data$other),
  r51=is.numeric(data$apc),
  r52=is.numeric(data$otherv),
  r53=data$groundhr >= 0,
  r54=data$groundtr >= 0,
  r55=data$airhr >= 0,
  r56=airtr >= 0,
  r57=data$deaths >= 0,
  r58=data$major >= 0,
  r59=data$minor >= 0,
  r60=data$assist >= 0,
  r61=data$other >= 0,
  r62=data$apc >= 0,
  r63=data$otherv >= 0,
  r64=(data$deaths+data$major+data$minor+data$assist+data$other)==(data$apc+data$otherv),
  r65=is.factor(data$reignit),
  r66=length(levels(data$reignit))==2,
  r67=data$reignit %in% c("no","yes"),
r68=is.factor(data$cty),
r69=data$cty %in% c("exact","not exact")
)
```


```{r}
out=confront(data, new.rules)
summary(out)[-c(6:8)]
```


# Save final data


```{r}
str(data)
summary(data)
```

```{r}
write_xlsx(data,col_names = TRUE,path = "finaldata.xlsx")
```
